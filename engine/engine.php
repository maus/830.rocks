<?php

$thingies = array(     	
	'before_05-05-2014' => array(
		'image' => 'before.jpg',
		'video' => '',
		'song' => 'Sigma feat. Paloma Faith - Changing',
		'embed' => 'oAeotgCHL3E',
		),
	'passionate_21-05-2014' => array(
		'image' => 'passionate.jpg',
		'video' => '',
		'song' => 'Chase & Status - Pressure',
		'embed' => 'tLwnAkE0YdI',
		),
	'beginning_23-05-2014' => array(
		'image' => 'beginning.jpg',
		'video' => '',
		'song' => 'Fink - See It All [Scuba Remix]',
		'embed' => 'u07X-wrG7s4',
		),
	'end_08-06-2014' => array(
		'image' => 'end.jpg',
		'video' => '',
		'song' => 'The War on Drugs - Eyes to the Wind',
		'embed' => 'H22kHZ-erpg',
		),
	'summer_19-06-2014' => array(
		'image' => 'vama-veche.jpeg',
		'video' => '',
		'song' => 'Parov Stelar feat. Graham Candy - The Sun',
		'embed' => 'WTrNsAsjEmY',
		),
	'coding_29-06-2014' => array(
		'image' => 'coding.jpg',
		'video' => '',
		'song' => 'Seinabo Sey - Younger',
		'embed' => 'GI5E5ewwN1s',
		),
	'alps_02-08-2014' => array(
		'image' => 'mountains.jpg',
		'video' => '',
		'song' => "Frank Ocean - Thinkin' Bout You",
		'embed' => 'tM6haybgBrc',
		),
	'appartment_04-08-2014' => array(
		'image' => 'newhome.jpg',
		'video' => '',
		'song' => 'Hans Zimmer - Time',
		'embed' => 'RxabLA7UQ9k',
		),
	'empty_07-08-2014' => array(
		'image' => 'empty.jpg',
		'video' => '',
		'song' => "Deep Dish - Summer's Over",
		'embed' => 'ear9wnAEKSs',
		),
	'happy_10-08-2014' => array(
		'image' => 'vista.jpg',
		'video' => '',
		'song' => 'Garbage - Only Happy When It Rains',
		'embed' => 'GpBFOJ3R0M4',
		),
	'sunshine_10-08-2014' => array(
		'image' => 'sunshine.jpg',
		'video' => 'sunshine',
		'song' => 'David Guetta feat. Sam Martin - Lovers on the Sun',
		'embed' => 'EpbjEttizy',
		),
	'tarmac_15-08-2014' => array(
		'image' => 'tarmac.jpg',
		'video' => '',
		'song' => 'James Hersey - Coming Over',
		'embed' => '8C__F4_3iwQ',
		),
	'rainy_18-08-2014' => array(
		'image' => 'rainy.jpg',
		'video' => '',
		'song' => 'James Hersey - Juliet',
		'embed' => 'c45Xqotx0bA',
		),
	'suncat_28-08-2014' => array(
		'image' => 'suncat.jpg',
		'video' => '',
		'song' => 'Jaymes Young - Habits Of My Heart [Sufjan Stevens Remake]',
		'embed' => 'EU_5kz8XL-w',
		),
	'back_05-09-2014' => array(
		'image' => 'entering-wien.jpg',
		'video' => '',
		'song' => 'Marbert Rocel - My Bed',
		'embed' => 'DhAlptt4eXk',
		),
	'romanticism_06-09-2014' => array(
		'image' => 'romanticism.jpg',
		'video' => '',
		'song' => 'Vance Joy - Riptide',
		'embed' => 'uJ_1HMAGb4k',
		),
	'41-hours_08-09-2014' => array(
		'image' => '41-hours.jpg',
		'video' => '',
		'song' => 'Zero 7 - Swing',
		'embed' => 'rw8-Yt2Ai3Q',
		),
	'perspective_08-09-2014' => array(
		'image' => 'perspective.jpg',
		'video' => '',
		'song' => 'Parov Stelar - Autumn Beasts',
		'embed' => 'Ts9-eSlsDlI',
		),
	'mccafe_28-09-2014' => array(
		'image' => 'mccafe.jpg',
		'video' => '',
		'song' => 'Of Monsters and Men - Little Talks',
		'embed' => 'ghb6eDopW8I',
		),
	'consequences_17-10-2014' => array(
		'image' => 'consequences.jpg',
		'video' => '',
		'song' => 'Kele - Silver and Gold',
		'embed' => 'Gb6hxAqxTIw',
		),
	'angry_03-11-2014' => array(
		'title' => 'Done',
		'image' => 'fog.jpg',
		'video' => '',
		'song' => 'Royal Wood - Do You Recall',
		'embed' => 'jP0-uS7tx3c',
		),
	'supermoon_17-09-2015' => array(
		'image' => 'supermoon.jpg',
		'video' => '',
		'song' => 'Beirut - No No No',
		'embed' => 'G8lOkgyPcaU',
		),
	'alright_23-10-2015' => array(
		'title' => 'Everything Is Alright',
		'image' => 'everything-is-alright.jpg',
		'video' => '',
		'song' => 'James Blake - A Case of You',
		'embed' => 'IV5Pk-gn19o',
		),
	'autumn_01-11-2015' => array(
		'image' => 'autumn.jpg',
		'song' => 'Beach House - Lazuli',
		'embed' => 'BfzFVbkutFE',
		),
	);

$journal = array(
	'27-10-2015_05-08' => array(
		'song' => 'Chris Malinchak - So Good to Me',
		'embed' => 'oVcG9lpZV24',
		'background' => '#DCB9A5',
		),
	'28-10-2015_01-45' => array(
		'song' => 'Jose Gonzales - Stay Alive',
		'embed' => 'NucJk8TxyRg',
		'background' => '#DFCFA3',
		),
	'29-10-2015_01-23' => array(
		'background' => 'rgba(220, 209, 164, .5)',
		),
	'30-10-2015_03-11' => array(
		'background' => '#F3F4E4',
		),
	'31-10-2015_14-50' => array(
		'background' => '#aaa',
		'image' => 'shinning-through.jpg',
		),
	'01-11-2015_02-05' => array(
		'background' => '#eee',
		),
	'03-11-2015_00-15' => array(
		'song' => 'Mumford and Sons - Stubborn Love',
		'embed' => '6GFvUCcljkM',
		'background' => 'rgba( 255, 0, 0, .2 )',
		),
	'04-11-2015_01-45' => array(
		'background' => '#D6E9D8',
		),
	'06-11-2015_02-33' => array(
		'background' => '#91BBCC',
		),
	'07-11-2015_00-51' => array(
		'background' => '#F08678',
		),
	'08-11-2015_02-42' => array(
		'background' => '#F7EB85',
		),
	'10-11-2015_01-40' => array(
		'background' => '#FF5B32',
		),
	'11-11-2015_02-16' => array(
		'background' => '#cdeb8e',
		'song' => 'Rhye - Stay',
		'embed' => 'sng_CdAAw8M',
		),
	'13-11-2015_04-08' => array(
		'image' => 'dambovita.jpg',
		'background' => '#DFCFA3',
		),
	'20-11-2015_12-18' => array(
		'image' => 'unlucky.jpg',
		'background' => 'rgba(191,106,31,.3)',
		'song' => 'Citizen Cope - Sideways',
		'embed' => 'ezz-nazThiM',
		),

	);

$pages = prepare_pages( array_merge( $thingies, $journal ) );
uasort( $pages, 'sort_pagesByTime' );

function sort_pagesByTime( $a, $b ) {
	return $a['time'] < $b['time'];
}

function prepare_pages( $pages ) {
	foreach ( $pages as $idx => $page ) {
		$is_from_theJournal = is_from_theJournal( $idx );
		$page['link'] = $idx;
		$fragments = explode( "_", $idx );
		$dateIDX = $is_from_theJournal ? 0 : 1;
		$dateFragments = explode( "-", $fragments[$dateIDX] );
		$day = $dateFragments[0];
		$month = $dateFragments[1];
		$year = $dateFragments[2];
		if ( $is_from_theJournal ) {
			$timeFragments = explode( "-", $fragments[1] );
			$hour = (int) $timeFragments[0];
			$minutes = (int) $timeFragments[1];
		} else {
			$hour = 0;
			$minutes = 0;
		}
		$page['time'] = mktime( $hour, $minutes, 0, $month, $day, $year );
		if ( empty( $page['title'] ) ) {
			$page['title'] = $is_from_theJournal ? $hour . ":" . sprintf( "%02d", $minutes ) : ucwords( $fragments[0] );
		}

		$pages[$idx] = $page;
	}

	return $pages;
}

define( "SITEROOT", get_siteRoot() );
define( "IMGS_URL", SITEROOT . '_/img/' );
define( "IMGS_PATH", ABSPATH . '_/img/' );
define( "THUMBS_URL", IMGS_URL . 'thumbs/' );
define( "THUMBS_PATH", IMGS_PATH . 'thumbs/' );

define( 'LATEST_THINGI', get_latestThingi() );
define( 'PAGE', page() );

require_once ABSPATH . 'engine/vendor/parsedown/Parsedown.php';
require_once ABSPATH . 'engine/vendor/parsedown-extra/ParsedownExtra.php';

if ( ! in_array( PAGE, array_keys( $pages ) ) && ( PAGE != 'archive' ) ) {
	header( 'HTTP/1.1 404 Not Found' );
	die( "<h1>That's not a thingi</h1>" );
}

function get_siteRoot() {
	$path = pathinfo($_SERVER['PHP_SELF']);
	switch ( $path['dirname'] ) {
		case '/' :
			$root = 'http://' . $_SERVER['HTTP_HOST'] . '/';
			break;

		case '\\' :
			$root = 'http://' . $_SERVER['HTTP_HOST'] . '/';
			break;

		default :
			'http://' . $_SERVER['HTTP_HOST'] . $path['dirname'] . '/';
	}
	$root = str_replace( array( 'engine/', 'html/', 'app/', 'managers/' ), '', $root );
	
	return $root;
}

function page() {
	return $page = ( empty( $_GET['page'] ) ) ? LATEST_THINGI : $_GET['page'];
}

function get_pageTemplate() {
	return PAGE . ".php";
}

function version_asset( $URL ) {
	if ( is_debugging() ) {
		$version = time();	
	} else {
		$version = @filemtime( ABSPATH . '_/' . $URL );
	}
	if ( $version ) {
		$path = pathinfo( $URL );
		
		$output = SITEROOT . '_/' . $path['dirname'] . '/' . $path['filename'] . '.' . $version . '.' . $path['extension'];
	} else {
		$output = SITEROOT . '_/' . $URL;	
	}
	
	echo $output;
}


function is_from_theJournal( $page = '' ) {
	global $journal;

	if ( ! $page ) {
		$page = PAGE;	
	}

	return in_array( $page, array_keys( $journal ) );
}

function get_latestThingi() {
	global $pages;
	
	$maxTime = 0;
	foreach ( $pages as $link => $thingi ) {
		if ( ! is_from_theJournal( $link ) && $thingi['time'] > $maxTime ) {
			$maxTime = $thingi['time'];
			$latest = $link;	
		}
	}
	
	return str_replace( ".php", "", $latest );
}

function display_archive() {
	global $pages;
	
	$output = "<ul id='archive'>";
	foreach ( $pages as $idx => $thingi ) {
		$link = $thingi['link'];
		$title = get_title( $link );
		$class = get_thingiClass( $link );
		$date = get_date( $link );
		$image = get_thumb( $link );

		if ( is_from_theJournal( $link ) ) {
			$output .= "<li class='" . $class . "'>
				<article class='" . $class . "'>
					<a href='" . $link . "' " . get_thingiBackgroundStyle( $link ) . ">
						<header>
							<p class='date'><span>" . $date . "</span></p>
							<h1>" . $thingi['title'] . "</h1>
						</header>";
						if ( $image ) {
							$output .= "<figure>
								<img src='" . $image . "' alt='' />
							</figure>";
						}
					$output .= "</a>
				</article>
			</li>";
		} else {
			$output .= "<li class='" . $class . "-container'>
				<article class='" . $class . "'>
					<a href='" . $link . "'>
						<header>
							<h1>" . $thingi['title'] . "</h1>
							<p class='date'><span>" . $date . "</span></p>
						</header>";
						if ( $image ) {
							$output .= "<figure>
								<img src='" . $image . "' alt='' />
							</figure>";
						}
					$output .= "</a>
				</article>
			</li>";
		}
	}
	
	echo $output;
}

function display_pagesMenu() {
	global $thingies;
	global $journal;

	$history = is_from_theJournal( PAGE ) ? $journal : $thingies;
	
	$output = "<ul id='history' class='off-canvas'>";
		$versions = false;
		$first = true;
		foreach ( $history as $link => $page ) {
			$linkText = format_linkText( $link );
			$aClass = ( PAGE == $link ) ? "active" : "";
			
			$liAttributes = "";	
			if ( $first ) {
				$liAttributes = " class='first'";
				$first = false;
			}
			
			$output .= "<li" . $liAttributes . "><a href='" . $link . "' class='" . $aClass . "'>" . $linkText . "</a></li>";
		}
	$output .= "</ul>";
	
	if ( count( $history ) > 1 || $versions ) echo $output; 
}

function format_linkText( $link ) {
	$linkText = get_title( $link ) . ' <small>(' . get_date( $link ) . ')</small>';
	
	return $linkText;
}

function get_title( $page = '' ) {
	global $pages;
	
	if ( ! $page ) {
		$page = PAGE;	
	}
	
	return $pages[$page]['title'];
}

function get_date( $page = '' ) {
	global $pages;

	if ( ! $page ) {
		$page = PAGE;	
	}
	
	$time = $pages[$page]['time'];
	$linkText = date( 'd.m.Y', $time );
	
	return $linkText;
}

function get_thumb( $page = '' ) {
	global $pages;
	
	if ( ! $page ) {
		$page = PAGE;	
	}

	if ( ! empty( $pages[$page]['image'] ) ) {
		$fileName = $pages[$page]['image'];
		$imagePath = IMGS_PATH . $fileName;
		$imageURL = IMGS_URL . $fileName;
		$thumbPath = THUMBS_PATH . $fileName;
		if ( ! is_dir( THUMBS_PATH ) ) {
			mkdir( THUMBS_PATH, 0755 );
		}

		if ( is_file( $imagePath ) ) {
			if ( ! is_file( $thumbPath ) ) {
				$image = @imagecreatefromjpeg( $imagePath );
				$imageWidth = @imagesx( $image );
				$imageHeight = @imagesy( $image );
				$thumbWidth = 800;
				$thumbHeight = $thumbWidth * ( $imageHeight / $imageWidth );

				$thumb = @imagecreatetruecolor( $thumbWidth, $thumbHeight );
    			$resizeSuccessful = @imagecopyresampled( $thumb, $image, 0, 0, 0, 0, $thumbWidth, $thumbHeight, $imageWidth, $imageHeight );

    			if ( $resizeSuccessful ) {
    				$savedImage = @imagejpeg( $thumb, $thumbPath, 60 ); 
					$URL = THUMBS_URL . $fileName;
    			} else {
    				$URL = $imageURL;
    			}
			} else {
				$URL = THUMBS_URL . $fileName;
			}

			return $URL;
		}
	} else {
		return false;
	}
}

function get_image( $page = '' ) {
	global $pages;
	
	if ( ! $page ) {
		$page = PAGE;	
	}
	
	/*
	$handle = fopen( $link . ".php", "r" );
	$HTML = fread( $handle, filesize( $link . ".php" ) );
	fclose( $handle );
	$DOM = new DOMDocument();
	$DOM->loadHTML( $HTML . "</body>" );
	libxml_use_internal_errors( true );
	if ( $videoElement = $DOM->getElementByID( "video-background" ) ) {
		$backgroundStyle = $videoElement->getAttribute( 'style' );
	} else {
		$imageElement = $DOM->getElementByID( "image" );
		$backgroundStyle = $imageElement->getAttribute( 'style' );
	}
	libxml_clear_errors();
	
	return str_replace( array( "background-image: url( ", " );" ), "", $backgroundStyle );
	*/
	
	return ( ! empty( $pages[$page]['image'] ) ? "_/img/" . $pages[$page]['image'] : false );
}

function get_imageHTML( $page = '' ) {
	if ( ! $page ) {
		$page = PAGE;	
	}
	
	return "<div id='image' style='background-image: url( " . get_image( $page ) . " );'></div>";
}



function get_video( $extension, $page = '' ) {
	global $thingies;

	if ( ! $page ) {
		$page = PAGE;	
	}
	
	return '_/video/' . $thingies[$page]['video'] . '.' . $extension;
}

function get_videoHTML( $page = '' ) {
	global $thingies;
	
	if ( ! $page ) {
		$page = PAGE;	
	}
	
	return "<div id='video-background' style='background-image: url( " . get_image( $page ) . " );'>
		<video autoplay loop muted poster='" . get_image( $page ) . "'>
			<source src='" . get_video( 'webm', $page ) . "' type='video/webm'>     
			<source src='" . get_video( 'mp4', $page ) . "' type='video/mp4'>
		</video>
	</div>";
}
	

function get_media( $page = '' ) {
	global $pages;
	
	if ( ! $page ) {
		$page = PAGE;	
	}
	
	if ( ! empty( $pages[$page]['video'] ) ) {
		return get_videoHTML( $page );
	} else {
		return get_imageHTML( $page );
	}
}

function get_thingiClass( $page = '' ) {
	global $pages;
	
	if ( ! $page ) {
		$page = PAGE;	
	}
	
	$parts = explode( "_", $page );

	$classes = array( 'the-' . $parts[0] );

	if ( is_from_theJournal( $page ) ) {
		$classes[] = 'from-the-journal';
		if ( get_image( $page ) ) {
			$classes[] = 'has-media';
		}
	}
	
	return implode( ' ', $classes );
}

function get_song( $page = '' ) {
	global $pages;
	
	if ( ! $page ) {
		$page = PAGE;	
	}
	
	return ! empty( $pages[$page]['song'] ) ? "<!-- " . $pages[$page]['song'] . " -->
        <iframe width='100%' height='100%' src='//www.youtube.com/embed/" . $pages[$page]['embed'] . "?rel=0' frameborder='0' allowfullscreen></iframe>" : false;
}

function display_fadingOutCSS( $page = '' ) {
	global $pages;
	global $thingies;
	
	if ( ! $page ) {
		$page = PAGE;	
	}
	
	if ( in_array( $page, array_keys( $thingies ) ) ) {
		$maximum = 180;
		$now = time();
		$then = $pages[$page]['time'];
		$timePassed = $now - $then;
		$daysPassed = intval( $timePassed / 60 / 60 / 24 );
		$percentage = min( $daysPassed * 100 / $maximum, 100 );
		$textOpacity = .3 + ( 1 - $percentage / 100 ) / 2;
		$mediaOpacity = .5 + ( 1 - $percentage / 100 ) / 2;
		?>
		<style>
			.<?php echo get_thingiClass(); ?> #text { opacity: <?php echo $textOpacity; ?>; }
			.<?php echo get_thingiClass(); ?> #image,
			.<?php echo get_thingiClass(); ?> #video-background { opacity: <?php echo $mediaOpacity; ?>; }
		</style>
		<?php
	}
}

function parse_directory() {
	$pages = array();
	$handle = opendir( '.' );
	$exclude = array( '.htaccess', 'index.php', 'archive.php' );
	while ( $file = readdir( $handle ) ) {
		if ( ! is_dir( $file ) && ! in_array( $file, $exclude ) ) {
			$day = substr( $file, strpos( $file, "_" ) + 1, 2 );
			$month = substr( $file, strpos( $file, "_" ) + 4, 2 );
			$year = substr( $file, strpos( $file, "_" ) + 7, 4 );
			$time = mktime( 0, 0, 0, $month, $day, $year );
			$info = pathinfo( $file );
			$fileName = basename( $file, "." . $info['extension'] );
			$link = $fileName;
			if ( isset( $pages[$time] ) ) {
				$time++;	
			}
			$pages[$time] = $link;
		}
	}
	ksort( $pages );
	
	return $pages;
}

//
function is_debugging() {
	return defined( 'DEBUG' ) && DEBUG;
}

function get_thingiBackgroundStyle( $page = '' ) {
	global $pages;
	
	if ( ! $page ) {
		$page = PAGE;	
	}

	$background = ! empty( $pages[$page] ) && ! empty( $pages[$page]['background'] ) ? $pages[$page]['background'] : '#000';

	return "style='background-color: " . $background . ";'";
}


function thingi_backgroundStyle( $page = '' ) {
	echo get_thingiBackgroundStyle( $page );
}